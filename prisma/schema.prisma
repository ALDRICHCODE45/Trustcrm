// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  reclutador
  GL
  Admin
  MK
}

enum Oficina {
  Oficina1
  Oficina2
}

enum UserState {
  ACTIVO
  INACTIVO
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  Oficina       Oficina   @default(Oficina1)
  password      String
  age           Int
  direccion     String
  State         UserState @default(ACTIVO)
  celular       String
  emailVerified DateTime?
  image         String?
  role          Role      @default(reclutador) // Valor por defecto
  ingreso       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones existentes
  Lead                 Lead[]
  Task                 Task[]
  LeadStatusHistory    LeadStatusHistory[] // Nueva relación
  VacancyStatusHistory VacancyStatusHistory[] // Nueva relación para historial de vacantes
  ContactInteraction   ContactInteraction[] // Nueva relación para las interacciones con contactos
  Logs                 Log[]
  notifications        Notification[]
  specialNotifications SpecialNotification[]
  taskNotifications    Task[]                 @relation("TaskNotificationRecipients")

  // Relaciones específicas con nombres únicos para Vacancy
  vacanciesReclutador Vacancy[] @relation("VacancyReclutador")
  vacanciesCreated    Vacancy[] @relation("VacancyCreator") // Renombrado para claridad

  // Relación específica con nombre único para Comment
  comments Comment[] @relation("CommentAuthor")

  // Otras relaciones
  Client       Client[]
  vacancyFiles VacancyFile[] @relation("VacancyFileAuthor")
}

// Modelo para registrar historial de cambios de estado de leads
model LeadStatusHistory {
  id        String     @id @default(cuid())
  lead      Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  status    LeadStatus
  changedAt DateTime   @default(now())

  // Para auditoría
  changedBy   User   @relation(fields: [changedById], references: [id], onDelete: Cascade)
  changedById String

  @@index([leadId, changedAt]) // Índice para optimizar consultas por lead y fecha
}

// Modelo para registrar historial de cambios de estado de vacantes
model VacancyStatusHistory {
  id        String        @id @default(cuid())
  vacancy   Vacancy       @relation(fields: [vacancyId], references: [id], onDelete: Cascade)
  vacancyId String
  status    VacancyEstado
  changedAt DateTime      @default(now())

  // Para auditoría
  changedBy   User   @relation(fields: [changedById], references: [id], onDelete: Cascade)
  changedById String

  @@index([vacancyId, changedAt]) // Índice para optimizar consultas por vacante y fecha
}

model Sector {
  id     String @id @default(cuid())
  nombre String @unique
  leads  Lead[]
}

model SubSector {
  id     String @id @default(cuid())
  nombre String @unique
  leads  Lead[]
}

model LeadOrigen {
  id        String    @id @default(cuid())
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  nombre    String    @unique
  leads     Lead[]
  Client    Client[]
}

enum LeadStatus {
  Contacto
  SocialSelling
  ContactoCalido
  //Se quita prospecciones
  CitaAgendada
  CitaAtendida
  CitaValidada
  Asignadas
  StandBy
}

model Lead {
  id               String      @id @default(cuid())
  empresa          String
  link             String
  status           LeadStatus  @default(Contacto)
  contactos        Person[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  numero_empleados Int?
  ubicacion        String?
  etiqueta         LeadStatus? @default(Contacto)

  // Relaciones con Sector y Origen
  sectorId       String
  sector         Sector              @relation(fields: [sectorId], references: [id])
  origenId       String
  origen         LeadOrigen          @relation(fields: [origenId], references: [id])
  // Relaciones -> Generador de leads
  generadorId    String
  generadorLeads User                @relation(fields: [generadorId], references: [id], onDelete: Cascade)
  statusHistory  LeadStatusHistory[]
  //Relaciones con subsector
  SubSector      SubSector?          @relation(fields: [subSectorId], references: [id])
  subSectorId    String?
  Client         Client[]
}

//modelo de contacto para todos los modulos
model Person {
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  //Datos principales
  id       String       @id @default(cuid())
  name     String
  email    String?
  phone    String?
  position String?
  linkedin String?
  cv       VacancyFile? @relation("PersonCV", fields: [cvFileId], references: [id]) // solo para candidatos o en un futuro para donde se necesite

  //Datos extra del candidato (vacancy) opcionales
  esta_empleado                   Boolean?
  sueldo_actual_o_ultimo          String?
  prestaciones_actuales_o_ultimas String?
  bonos_comisiones                String?
  otros_beneficios                String?
  expectativa_económica          String?
  direccion_actual                String?
  modalidad_actual_o_ultima       String?
  ubicacion_ultimo_trabajo        String?
  empresa_actual_o_ultima         String?
  //validacion de candidato para hacer entrevistas
  IsCandidateValidated            Boolean  @default(false)

  //etiqueta del contacto
  etiqueta LeadStatus @default(Contacto)

  //relaciones -> contacto de leads
  Lead   Lead?   @relation(fields: [leadId], references: [id])
  leadId String?

  // Nueva relación para las interacciones/conversaciones
  interactions ContactInteraction[]

  // Relaciones específicas con Vacancy
  vacanciesContratado    Vacancy[]                @relation("VacancyCandidatoContratado")
  vacanciesTernaFinal    Vacancy[]                @relation("VacancyTernaFinal")
  Client                 Client?                  @relation(fields: [clientId], references: [id])
  clientId               String?
  cvFileId               String?                  @unique
  InputChecklistFeedback InputChecklistFeedback[]
}

enum VacancyTipo {
  Nueva
  Recompra
  Garantia
}

enum VacancyEstado {
  QuickMeeting
  Hunting
  Cancelada
  Entrevistas
  Perdida
  PrePlacement
  Placement
}

enum VacancyPrioridad {
  Alta
  Normal
  Baja
}

model Vacancy {
  createdAt             DateTime?        @default(now())
  updatedAt             DateTime?        @updatedAt
  id                    String           @id @default(uuid())
  fechaAsignacion       DateTime
  reclutadorId          String
  reclutador            User             @relation("VacancyReclutador", fields: [reclutadorId], references: [id])
  tipo                  VacancyTipo      @default(Nueva)
  estado                VacancyEstado    @default(Hunting)
  posicion              String
  tiempoTranscurrido    Int?
  Comments              Comment[]
  prioridad             VacancyPrioridad @default(Normal)
  fechaEntrega          DateTime?
  fechaEntregaTerna     DateTime?
  duracionTotal         Int?
  fechaOferta           DateTime?
  candidatoContratado   Person?          @relation("VacancyCandidatoContratado", fields: [candidatoContratadoId], references: [id])
  candidatoContratadoId String?
  salario               Int?
  fechaComision         DateTime?
  monto                 Int?
  valorFactura          Float?
  fee                   Float?
  ternaFinal            Person[]         @relation("VacancyTernaFinal")

  //Detalles de la vacante NO OBLIGATORIOS 
  prestaciones String?
  herramientas String?
  comisiones   String?
  modalidad    String?
  horario      String?
  psicometria  String?
  ubicacion    String?
  comentarios  String?

  // Relación con el cliente
  cliente   Client @relation(fields: [clienteId], references: [id])
  clienteId String

  // Relación con archivos generales
  files VacancyFile[] @relation("VacancyFiles")

  // Relación con perfiles muestra (múltiples)
  perfilesMuestra          VacancyFile[] @relation("VacancyPerfilMuestra")
  //Perfil Muestra validado
  IsPerfilMuestraValidated Boolean       @default(false)

  //Job Description (solo uno)
  JobDescription   VacancyFile? @relation("VacancyJobDescription", fields: [jobDescriptionId], references: [id])
  jobDescriptionId String?      @unique

  // Datos del usuario que creo la vacante
  creator   User?   @relation("VacancyCreator", fields: [creatorId], references: [id]) // Renombrado para claridad
  creatorId String?

  // Relación con checklist
  InputChecklist       InputChecklist[]
  IsChecklistValidated Boolean          @default(false)
  // Relación con tareas
  tasks                Task[]

  //Relacion con notificaciones normal
  Notification Notification[]

  // Relación con historial de estados
  statusHistory VacancyStatusHistory[]
}

model InputChecklist {
  id        String   @id @default(uuid())
  vacancyId String?
  vacancy   Vacancy? @relation(fields: [vacancyId], references: [id], onDelete: Cascade)
  content   String

  // Datos del candidato para comparar con el contenido del checklist

  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  InputChecklistFeedback InputChecklistFeedback[]
}

model InputChecklistFeedback {
  id               String         @id @default(uuid())
  inputChecklistId String
  inputChecklist   InputChecklist @relation(fields: [inputChecklistId], references: [id], onDelete: Cascade)
  candidate        Person?        @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  candidateId      String?
  feedback         String

  //Datos de auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VacancyFile {
  id String @id @default(uuid())

  // Relación con vacante para archivos generales
  vacancyId String?
  vacancy   Vacancy? @relation("VacancyFiles", fields: [vacancyId], references: [id], onDelete: Cascade)

  // Relación con vacante para perfiles muestra
  perfilMuestraVacancyId String?
  perfilMuestraVacancy   Vacancy? @relation("VacancyPerfilMuestra", fields: [perfilMuestraVacancyId], references: [id], onDelete: Cascade)

  // Relación específica para JobDescription (uno a uno)
  jobDescriptionVacancy Vacancy? @relation("VacancyJobDescription")

  // Datos del archivo
  url       String
  name      String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Autor del archivo
  authorId String?
  author   User?   @relation("VacancyFileAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  // Relación con Person para CVs
  personCV Person? @relation("PersonCV")

  @@index([vacancyId])
  @@index([perfilMuestraVacancyId])
  @@index([authorId])
}

enum ClienteEtiqueta {
  PreCliente
  Cliente
}

enum ClienteModalidad {
  Exito
  Anticipo
}

model Client {
  //Datos de auditoria
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  //Data principal
  id           String            @id @default(cuid())
  //Relacion con el lead
  leadId       String?
  lead         Lead?             @relation(fields: [leadId], references: [id])
  //Etiqueta del cliente
  etiqueta     ClienteEtiqueta   @default(PreCliente)
  //Data de la cuenta y estadisticas
  cuenta       String?
  asignadas    Int?
  perdidas     Int?
  canceladas   Int?
  placements   Int?
  tp_placement Int?
  contactos    Person[]
  modalidad    ClienteModalidad? @default(Exito)

  fee           Int?
  dias_credito  Int?
  tipo_factura  String?
  razon_social  String?
  regimen       String?
  rfc           String?
  codigo_postal String?
  como_factura  String?
  portal_site   String?
  comentarios   Comment[]
  tipo          String?
  //Origen en caso de que no haya lead
  origenId      String?
  origen        LeadOrigen? @relation(fields: [origenId], references: [id])
  //Relacion con el usuario
  usuarioId     String
  usuario       User        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  Vacancy       Vacancy[]
}

model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  content   String
  task      Task?    @relation(fields: [taskId], references: [id])
  taskId    String?  @unique
  vacancy   Vacancy? @relation(fields: [vacancyId], references: [id]) // Hecho opcional
  vacancyId String?
  author    User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String
  Client    Client?  @relation(fields: [clientId], references: [id])
  clientId  String?
}

enum TaskStatus {
  Pending
  Done
}

// Modelo para las interacciones con contactos
model ContactInteraction {
  id         String   @id @default(cuid())
  content    String // Contenido del comentario o estado de la negociación
  contacto   Person   @relation(fields: [contactoId], references: [id], onDelete: Cascade)
  contactoId String
  autor      User     @relation(fields: [autorId], references: [id], onDelete: Cascade)
  autorId    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  linkedTasks Task[] // Relación uno a muchos a tareas

  // Campo opcional para adjuntar un archivo
  attachmentUrl  String?
  attachmentName String?
  attachmentType String?

  @@index([contactoId, createdAt]) // Índice para optimizar consultas por contacto y fecha
}

model Task {
  id                     String         @id @default(uuid())
  title                  String
  description            String
  assignedTo             User           @relation(fields: [assignedToId], references: [id], onDelete: Cascade)
  assignedToId           String
  comment                Comment?       @relation
  commentId              String?
  status                 TaskStatus     @default(Pending)
  dueDate                DateTime
  createdAt              DateTime       @default(now())
  notifications          Notification[]
  notifyOnComplete       Boolean        @default(false)
  notificationRecipients User[]         @relation("TaskNotificationRecipients")
  //valor para saber si es una tarea importante para el reclutador
  isImportant            Boolean        @default(false)

  // Relación bidireccional con ContactInteraction
  // Una tarea solo puede estar vinculada a una interacción
  linkedInteraction ContactInteraction? @relation(fields: [interactionId], references: [id])
  interactionId     String?

  // Nueva relación opcional con Vacancy
  vacancy   Vacancy? @relation(fields: [vacancyId], references: [id])
  vacancyId String?

  @@index([interactionId]) // Índice para optimizar consultas por interacción vinculada
  @@index([vacancyId]) // Índice para optimizar consultas por vacante vinculada
}

enum LogAction {
  Publicar
  Eliminar
  Actualizar
  Ingresar
}

enum LogModule {
  Leads
  Reclutamiento
  Sistema
  Usuarios
}

model Log {
  id        String    @id @default(cuid())
  autor     User      @relation(fields: [autorId], references: [id], onDelete: Cascade)
  autorId   String
  action    LogAction
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  file      String?
  logModule LogModule @default(Sistema)
}

enum NotificationType {
  TASK_INITIALIZED
  TASK_COMPLETED
  TASK_OVERDUE
  EDIT
  Vacancy
}

enum NotificationStatus {
  UNREAD
  READ
}

model Notification {
  id          String             @id @default(cuid())
  type        NotificationType
  status      NotificationStatus @default(UNREAD)
  message     String
  task        Task?              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId      String?
  recipient   User               @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  recipientId String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  vacancy     Vacancy?           @relation(fields: [vacancyId], references: [id], onDelete: Cascade)
  vacancyId   String?

  @@index([recipientId, status])
}

enum SpecialNotificationType {
  VACANCY_ASSIGNED
  VACANCY_STATUS_CHANGED
  CLIENT_ASSIGNED
  URGENT_TASK_ASSIGNED
}

enum SpecialNotificationStatus {
  PENDING
  SHOWN
  DISMISSED
}

enum SpecialNotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SpecialNotification {
  id       String                      @id @default(cuid())
  type     SpecialNotificationType
  status   SpecialNotificationStatus   @default(PENDING)
  priority SpecialNotificationPriority @default(MEDIUM)
  title    String
  message  String

  // Relación con el destinatario
  recipient   User   @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  recipientId String

  // Relaciones opcionales con entidades específicas

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, status])
  @@index([type, status])
  @@index([priority, status])
}
